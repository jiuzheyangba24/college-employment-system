<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå°±ä¸šåŠ©æ‰‹ - é«˜æ ¡å°±ä¸šä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .chat-container {
            height: calc(100vh - 220px);
            display: flex;
            flex-direction: column;
            background: #fff;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: linear-gradient(180deg, #f8f9ff 0%, #fff 100%);
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .message.ai .message-avatar {
            background: linear-gradient(135deg, #4361ee, #3f37c9);
            color: #fff;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #4cc9f0, #4895ef);
            color: #fff;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            margin: 0 15px;
            line-height: 1.6;
        }

        .message.ai .message-content {
            background: #fff;
            border: 1px solid #e8e8e8;
            border-radius: 20px 20px 20px 5px;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #4361ee, #3f37c9);
            color: #fff;
            border-radius: 20px 20px 5px 20px;
        }

        .chat-input-area {
            padding: 20px 30px;
            background: #fff;
            border-top: 1px solid #eee;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            border: 2px solid #e8e8e8;
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .chat-input:focus {
            border-color: #4361ee;
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
        }

        .send-btn {
            width: 55px;
            height: 55px;
            border-radius: 15px;
            background: linear-gradient(135deg, #4361ee, #3f37c9);
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 10px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #4361ee;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-10px);
            }
        }

        .welcome-message {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .welcome-message i {
            font-size: 60px;
            background: linear-gradient(135deg, #4361ee, #3f37c9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .quick-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .quick-question {
            background: #f0f4ff;
            color: #4361ee;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .quick-question:hover {
            background: #4361ee;
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header"><i class="fas fa-graduation-cap d-block mb-3"
                style="font-size: 40px; color: var(--primary-color);"></i>
            <h4>å°±ä¸šä¿¡æ¯ç®¡ç†</h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="/"><i class="fas fa-tachometer-alt"></i>é¦–é¡µä»ªè¡¨ç›˜</a></li>
            <li><a href="/students"><i class="fas fa-users"></i>å­¦ç”Ÿç®¡ç†</a></li>
            <li><a href="/employment"><i class="fas fa-briefcase"></i>å°±ä¸šä¿¡æ¯</a></li>
            <li><a href="/departments"><i class="fas fa-building"></i>é™¢ç³»ç®¡ç†</a></li>
            <li><a href="/majors"><i class="fas fa-book"></i>ä¸“ä¸šç®¡ç†</a></li>
            <li><a href="/industries"><i class="fas fa-industry"></i>è¡Œä¸šç®¡ç†</a></li>
            <li><a href="/ai/page" class="active"><i class="fas fa-robot"></i>AIå°±ä¸šåŠ©æ‰‹</a></li>
        </ul>
    </div>
    <div class="main-content">
        <nav class="top-navbar glass-panel">
            <div class="page-title"><i class="fas fa-robot me-2 text-primary"></i>AIå°±ä¸šåŠ©æ‰‹</div>
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown"
                    style="background: rgba(255,255,255,0.8); border:none;"><i
                        class="fas fa-user-circle me-2 text-primary"></i>ç®¡ç†å‘˜</button>
                <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg">
                    <li><a class="dropdown-item" href="/logout"><i
                                class="fas fa-sign-out-alt me-2 text-danger"></i>é€€å‡ºç™»å½•</a></li>
                </ul>
            </div>
        </nav>
        <div class="content-wrapper animate-fade-in">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <!-- æ˜¾ç¤ºå†å²è®°å½• -->
                    <th:block th:if="${chatHistory != null and !chatHistory.isEmpty()}">
                        <div th:each="msg : ${chatHistory}"
                            th:class="${msg.role == 'user' ? 'message user' : 'message ai'}">
                            <div class="message-avatar">
                                <i th:class="${msg.role == 'user' ? 'fas fa-user' : 'fas fa-robot'}"></i>
                            </div>
                            <div class="message-content" th:utext="${msg.content}"></div>
                        </div>
                    </th:block>
                    <!-- æ¬¢è¿æ¶ˆæ¯ï¼ˆæ— å†å²æ—¶æ˜¾ç¤ºï¼‰ -->
                    <div class="welcome-message" th:if="${chatHistory == null or chatHistory.isEmpty()}">
                        <i class="fas fa-robot d-block"></i>
                        <h4>ä½ å¥½ï¼æˆ‘æ˜¯AIå°±ä¸šåŠ©æ‰‹</h4>
                        <p>æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£ç­”å°±ä¸šç›¸å…³é—®é¢˜ï¼ŒåŒ…æ‹¬èŒä¸šè§„åˆ’ã€ç®€å†æ’°å†™ã€é¢è¯•æŠ€å·§ç­‰</p>
                        <div class="quick-questions">
                            <button class="quick-question" onclick="askQuestion('å¦‚ä½•æ’°å†™ä¸€ä»½ä¼˜ç§€çš„ç®€å†ï¼Ÿ')">ğŸ“ å¦‚ä½•å†™ç®€å†</button>
                            <button class="quick-question" onclick="askQuestion('åº”å±Šæ¯•ä¸šç”Ÿå¦‚ä½•åšå¥½èŒä¸šè§„åˆ’ï¼Ÿ')">ğŸ¯ èŒä¸šè§„åˆ’</button>
                            <button class="quick-question" onclick="askQuestion('é¢è¯•æ—¶æœ‰å“ªäº›æ³¨æ„äº‹é¡¹ï¼Ÿ')">ğŸ’¼ é¢è¯•æŠ€å·§</button>
                            <button class="quick-question" onclick="askQuestion('å½“å‰ITè¡Œä¸šçš„å°±ä¸šå‰æ™¯å¦‚ä½•ï¼Ÿ')">ğŸ’» è¡Œä¸šåˆ†æ</button>
                        </div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-wrapper">
                        <button class="btn btn-outline-danger me-2" onclick="clearHistory()" title="æ¸…é™¤å¯¹è¯"><i
                                class="fas fa-trash"></i></button>
                        <input type="text" class="chat-input" id="userInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
                            onkeypress="if(event.keyCode===13)sendMessage()">
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()"><i
                                class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        var hasHistory = /*[[${chatHistory != null and !chatHistory.isEmpty()}]]*/ false;
        var isFirstMessage = !hasHistory;

        // é¡µé¢åŠ è½½æ—¶æ»šåŠ¨åˆ°åº•éƒ¨
        $(function () {
            if (hasHistory) {
                scrollToBottom();
            }
        });

        function askQuestion(question) {
            $('#userInput').val(question);
            sendMessage();
        }

        function sendMessage() {
            var message = $('#userInput').val().trim();
            if (!message) return;

            // æ¸…é™¤æ¬¢è¿æ¶ˆæ¯
            if (isFirstMessage) {
                $('.welcome-message').remove();
                isFirstMessage = false;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            appendMessage('user', message);
            $('#userInput').val('');
            $('#sendBtn').prop('disabled', true);

            // æ·»åŠ AIæ€è€ƒä¸­çš„æ¶ˆæ¯
            var aiMsgId = 'ai-' + Date.now();
            appendMessage('ai', '<div class="typing-indicator"><span></span><span></span><span></span></div>', aiMsgId);

            // æµå¼æ¥æ”¶AIå“åº”
            var aiContent = '';
            var eventSource = new EventSource('/ai/chat?message=' + encodeURIComponent(message));

            eventSource.onmessage = function (event) {
                aiContent += event.data;
                $('#' + aiMsgId + ' .message-content').html(formatMessage(aiContent));
                scrollToBottom();
            };

            eventSource.onerror = function (e) {
                eventSource.close();
                $('#sendBtn').prop('disabled', false);
                if (!aiContent) {
                    $('#' + aiMsgId + ' .message-content').html('æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚');
                }
            };
        }

        function appendMessage(type, content, id) {
            var avatar = type === 'ai' ? '<i class="fas fa-robot"></i>' : '<i class="fas fa-user"></i>';
            var html = '<div class="message ' + type + '" ' + (id ? 'id="' + id + '"' : '') + '>' +
                '<div class="message-avatar">' + avatar + '</div>' +
                '<div class="message-content">' + content + '</div>' +
                '</div>';
            $('#chatMessages').append(html);
            scrollToBottom();
        }

        function formatMessage(text) {
            return text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^\d+\./gm, '<br>$&');
        }

        function scrollToBottom() {
            var chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function clearHistory() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ')) return;
            $.post('/ai/clear', function (res) {
                if (res.success) {
                    location.reload();
                }
            });
        }
    </script>
</body>

</html>